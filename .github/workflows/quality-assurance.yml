name: ğŸ§ª Quality Assurance

on:
  schedule:
    # Run quality checks every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Comprehensive Quality Checks
  quality-checks:
    name: ğŸ” Quality Assessment
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps --legacy-peer-deps

      - name: ğŸ” ESLint with detailed reporting
        run: |
          npx eslint . --ext ts,tsx,js,jsx --format json --output-file eslint-report.json || true
          npx eslint . --ext ts,tsx,js,jsx --format stylish

      - name: ğŸ›¡ï¸ Security audit with detailed report
        run: |
          npm audit --audit-level=low --json > audit-report.json || true
          npm audit --audit-level=moderate

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "ANALYZE=true" >> $GITHUB_ENV
          GITHUB_PAGES=true npm run build
          echo "## ğŸ“¦ Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Static build completed successfully for bundle analysis" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ§ª TypeScript strict check
        run: |
          npx tsc --noEmit --strict
          echo "âœ… TypeScript strict mode check passed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ˆ Lighthouse CI with artifacts
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.lighthouserc.js'
          temporaryPublicStorage: true
          uploadArtifacts: true

      - name: ğŸ“Š Generate quality report
        run: |
          echo "## ğŸ¯ Quality Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript compilation: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint checks: $([ -s eslint-report.json ] && echo 'Issues found (see details)' || echo 'Passed')" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security audit: $([ -s audit-report.json ] && echo 'Vulnerabilities detected' || echo 'Clean')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse scores available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle analysis completed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            eslint-report.json
            audit-report.json
            .lighthouseci/
          retention-days: 30

  # Dependency Health Check
  dependency-health:
    name: ğŸ“¦ Dependency Health
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“Š Check for outdated dependencies
        run: |
          echo "## ğŸ“¦ Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "ğŸŸ¡ **Outdated packages found**" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm outdated\` locally to see details" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All dependencies are up to date**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” Security vulnerability scan
        run: |
          npm audit --audit-level=low --json > security-audit.json || true
          if [ -s security-audit.json ]; then
            echo "ğŸ”´ **Security vulnerabilities detected**" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm audit\` locally and \`npm audit fix\` to resolve" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No security vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“ˆ License compliance check
        run: |
          npx license-checker --summary --onlyAllow 'MIT;Apache-2.0;BSD;ISC;0BSD;BSD-3-Clause;BSD-2-Clause' || echo "âš ï¸ License compliance issues detected"

      - name: ğŸ“¤ Upload dependency reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: |
            outdated.json
            security-audit.json
          retention-days: 14